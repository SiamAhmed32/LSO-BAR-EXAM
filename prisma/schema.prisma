generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  carts     Cart[]
  orders    Order[]
  examAttempts ExamAttempt[]

  @@index([email])
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

model Contact {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("contacts")
}

enum ExamType {
  BARRISTER
  SOLICITOR
}

enum PricingType {
  FREE
  PAID
}

enum ExamSet {
  SET_A
  SET_B
}

model Exam {
  id           String      @id @default(uuid())
  examType     ExamType
  pricingType  PricingType
  price        Float?
  examTime     String?
  attemptCount  Int?
  examSet      ExamSet?
  title        String?
  description  String?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  
  questions    Question[]
  carts        Cart[]
  orderItems   OrderItem[]
  examAttempts ExamAttempt[]

  @@index([examType])
  @@index([pricingType])
  @@index([examSet])
  @@unique([examType, pricingType, examSet])
  @@map("exams")
}

model Question {
  id        String   @id @default(uuid())
  examId    String
  question  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  options   Option[]
  cartItems Item[]
  
  @@index([examId])
  @@map("questions")
}

model Option {
  id         String   @id @default(uuid())
  questionId String
  text       String
  isCorrect  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("options")
}

model Cart {
  id        String   @id @default(uuid())
  userId    String
  examId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  items     Item[]

  @@unique([userId, examId])
  @@index([userId])
  @@index([examId])
  @@map("carts")
}

model Item {
  id         String   @id @default(uuid())
  cartId     String
  questionId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([cartId, questionId])
  @@index([cartId])
  @@index([questionId])
  @@map("items")
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
}

model Order {
  id            String        @id @default(uuid())
  userId        String
  totalAmount   Float
  status        OrderStatus   @default(PENDING)
  billingName   String
  billingEmail  String
  billingAddress String?
  billingCity   String?
  billingState  String?
  billingPostcode String?
  billingCountry String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  payment       Payment?

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  examId    String
  examTitle String?
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  exam      Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  examAttempts ExamAttempt[]

  @@index([orderId])
  @@index([examId])
  @@map("order_items")
}

model Payment {
  id                String        @id @default(uuid())
  orderId           String       @unique
  stripePaymentId   String?      @unique
  stripeClientSecret String?
  amount            Float
  currency          String        @default("usd")
  status            PaymentStatus @default(PENDING)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  order             Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([stripePaymentId])
  @@index([status])
  @@map("payments")
}

model ExamAttempt {
  id            String   @id @default(uuid())
  userId        String
  examId        String
  orderItemId   String?  // Link attempt to the order item that granted access
  totalQuestions Int
  answeredCount  Int
  correctCount   Int
  incorrectCount Int
  unansweredCount Int
  score          Float   // Percentage score
  answers        Json    // Store user's answers as JSON
  submittedAt    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam          Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  orderItem     OrderItem? @relation(fields: [orderItemId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([examId])
  @@index([orderItemId])
  @@index([submittedAt])
  @@map("exam_attempts")
}